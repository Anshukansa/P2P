<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple File Transfer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .main {
            padding: 25px;
        }
        
        .device-section {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .device-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #4CAF50;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .device-circle:hover {
            transform: scale(1.05);
        }
        
        .device-circle.waiting {
            background: #2196F3;
            animation: pulse 2s infinite;
        }
        
        .device-circle.connected {
            background: #4CAF50;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .connection-code {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 3px;
            color: #333;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-download {
            background: #FF9800;
            color: white;
            margin: 10px 0;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .file-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .file-area.drag-over {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .file-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .file-size {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .hidden {
            display: none;
        }
        
        .received-files {
            margin-top: 20px;
        }
        
        .download-item {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÅ File Transfer</h1>
            <p>Simple & reliable file sharing</p>
        </div>
        
        <div class="main">
            <!-- Device Status -->
            <div class="device-section">
                <div id="status-text">Ready to start</div>
                <div id="device-circle" class="device-circle" onclick="startHost()">
                    <span id="device-text">START</span>
                </div>
                
                <!-- Connection Code -->
                <div id="code-section" class="hidden">
                    <div>Share this code:</div>
                    <div id="connection-code" class="connection-code">------</div>
                </div>
            </div>
            
            <!-- Messages -->
            <div id="messages"></div>
            
            <!-- File Selection -->
            <input type="file" id="file-input" multiple style="display: none;">
            <button class="btn btn-primary" onclick="selectFiles()" id="send-btn" disabled>
                üì§ Select Files to Send
            </button>
            
            <!-- Drag Drop -->
            <div class="file-area" id="drop-area">
                <p>üìé Drop files here or click above</p>
            </div>
            
            <!-- Sending Files -->
            <div id="sending-files"></div>
            
            <!-- Connection -->
            <input type="text" id="peer-code" placeholder="Enter code from other device" class="input-field">
            <button class="btn btn-success" onclick="connectToPeer()" id="connect-btn">
                üîó Connect
            </button>
            
            <!-- Received Files -->
            <div id="received-files" class="received-files"></div>
            
            <!-- Disconnect -->
            <button class="btn btn-danger hidden" onclick="disconnect()" id="disconnect-btn">
                ‚ùå Disconnect
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        class SimpleFileTransfer {
            constructor() {
                this.peer = null;
                this.connection = null;
                this.connectionCode = '';
                this.isConnected = false;
                this.receivingFiles = new Map();
                this.chunkSize = 64 * 1024; // 64KB chunks
                
                this.init();
            }
            
            init() {
                this.setupDragDrop();
                this.setupFileInput();
                this.checkUrlCode();
                this.log('System initialized');
            }
            
            log(message) {
                console.log('[FileTransfer]', message);
            }
            
            setupDragDrop() {
                const dropArea = document.getElementById('drop-area');
                
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('drag-over');
                });
                
                dropArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('drag-over');
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    this.handleFiles(files);
                });
            }
            
            setupFileInput() {
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
            }
            
            checkUrlCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('connect');
                if (code) {
                    document.getElementById('peer-code').value = code;
                    setTimeout(() => this.connectToPeer(), 1000);
                }
            }
            
            generateCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            async startHost() {
                try {
                    this.connectionCode = this.generateCode();
                    this.showMessage('Starting...', 'info');
                    
                    this.peer = new Peer(this.connectionCode, {
                        debug: 0,
                        config: {
                            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                        }
                    });
                    
                    this.peer.on('open', (id) => {
                        this.log(`Host started with ID: ${id}`);
                        this.updateStatus('Waiting for connection...', 'waiting');
                        this.showConnectionCode();
                        this.showMessage('Share the code with other device', 'info');
                    });
                    
                    this.peer.on('connection', (conn) => {
                        this.log('Someone connected');
                        this.connection = conn;
                        this.setupConnection();
                    });
                    
                    this.peer.on('error', (err) => {
                        this.log(`Peer error: ${err}`);
                        this.showMessage('Connection failed. Try again.', 'error');
                        this.resetConnection();
                    });
                    
                } catch (error) {
                    this.log(`Start error: ${error}`);
                    this.showMessage('Failed to start. Try again.', 'error');
                }
            }
            
            async connectToPeer() {
                const code = document.getElementById('peer-code').value.trim().toUpperCase();
                if (!code) {
                    this.showMessage('Please enter a code', 'error');
                    return;
                }
                
                try {
                    this.showMessage('Connecting...', 'info');
                    
                    this.peer = new Peer({
                        debug: 0,
                        config: {
                            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                        }
                    });
                    
                    this.peer.on('open', () => {
                        this.log('Connecting to peer');
                        this.connection = this.peer.connect(code);
                        this.setupConnection();
                        this.updateStatus('Connecting...', 'waiting');
                    });
                    
                    this.peer.on('error', (err) => {
                        this.log(`Connect error: ${err}`);
                        this.showMessage('Failed to connect. Check code.', 'error');
                        this.resetConnection();
                    });
                    
                } catch (error) {
                    this.log(`Connect error: ${error}`);
                    this.showMessage('Connection failed. Try again.', 'error');
                }
            }
            
            setupConnection() {
                if (!this.connection) return;
                
                this.connection.on('open', () => {
                    this.log('Connection established');
                    this.isConnected = true;
                    this.updateStatus('Connected!', 'connected');
                    this.showMessage('‚úÖ Connected! Ready to share files.', 'success');
                    this.enableFileSharing();
                });
                
                this.connection.on('data', (data) => {
                    this.handleReceivedData(data);
                });
                
                this.connection.on('close', () => {
                    this.log('Connection closed');
                    this.showMessage('Connection closed', 'error');
                    this.resetConnection();
                });
                
                this.connection.on('error', (err) => {
                    this.log(`Connection error: ${err}`);
                    this.showMessage('Connection error', 'error');
                    this.resetConnection();
                });
            }
            
            showConnectionCode() {
                document.getElementById('connection-code').textContent = this.connectionCode;
                document.getElementById('code-section').classList.remove('hidden');
            }
            
            updateStatus(message, state) {
                document.getElementById('status-text').textContent = message;
                const circle = document.getElementById('device-circle');
                const text = document.getElementById('device-text');
                
                circle.className = 'device-circle';
                if (state) circle.classList.add(state);
                
                switch (state) {
                    case 'waiting':
                        text.textContent = 'WAITING';
                        break;
                    case 'connected':
                        text.textContent = 'CONNECTED';
                        break;
                    default:
                        text.textContent = 'START';
                }
            }
            
            enableFileSharing() {
                document.getElementById('send-btn').disabled = false;
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('disconnect-btn').classList.remove('hidden');
            }
            
            handleFiles(files) {
                if (!this.isConnected) {
                    this.showMessage('Please connect first', 'error');
                    return;
                }
                
                Array.from(files).forEach((file, index) => {
                    this.sendFile(file, index);
                });
            }
            
            async sendFile(file, index) {
                this.log(`Sending file: ${file.name}`);
                
                // Show sending UI
                const sendingContainer = document.getElementById('sending-files');
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.id = `sending-${index}`;
                fileDiv.innerHTML = `
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${this.formatFileSize(file.size)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-${index}"></div>
                    </div>
                    <div class="progress-text" id="progress-text-${index}">Preparing...</div>
                `;
                sendingContainer.appendChild(fileDiv);
                
                // Send file metadata
                this.connection.send({
                    type: 'file-start',
                    name: file.name,
                    size: file.size,
                    id: index
                });
                
                // Send file in chunks
                const totalChunks = Math.ceil(file.size / this.chunkSize);
                
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * this.chunkSize;
                    const end = Math.min(start + this.chunkSize, file.size);
                    const chunk = file.slice(start, end);
                    
                    const arrayBuffer = await chunk.arrayBuffer();
                    
                    this.connection.send({
                        type: 'file-chunk',
                        id: index,
                        chunkIndex: i,
                        data: arrayBuffer,
                        isLast: i === totalChunks - 1
                    });
                    
                    // Update progress
                    const progress = ((i + 1) / totalChunks) * 100;
                    document.getElementById(`progress-${index}`).style.width = `${progress}%`;
                    document.getElementById(`progress-text-${index}`).textContent = `${Math.round(progress)}%`;
                    
                    // Small delay to prevent overwhelming
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
                
                this.log(`File sent: ${file.name}`);
                document.getElementById(`progress-text-${index}`).textContent = '‚úÖ Sent!';
            }
            
            handleReceivedData(data) {
                if (data.type === 'file-start') {
                    this.log(`Receiving file: ${data.name}`);
                    
                    this.receivingFiles.set(data.id, {
                        name: data.name,
                        size: data.size,
                        chunks: [],
                        receivedSize: 0
                    });
                    
                    this.showReceivingFile(data);
                    
                } else if (data.type === 'file-chunk') {
                    this.handleFileChunk(data);
                }
            }
            
            showReceivingFile(fileInfo) {
                const container = document.getElementById('received-files');
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.id = `receiving-${fileInfo.id}`;
                fileDiv.innerHTML = `
                    <div class="file-name">üì• ${fileInfo.name}</div>
                    <div class="file-size">${this.formatFileSize(fileInfo.size)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="receive-progress-${fileInfo.id}"></div>
                    </div>
                    <div class="progress-text" id="receive-text-${fileInfo.id}">Receiving...</div>
                `;
                container.appendChild(fileDiv);
            }
            
            handleFileChunk(chunkData) {
                const fileInfo = this.receivingFiles.get(chunkData.id);
                if (!fileInfo) return;
                
                // Store chunk
                fileInfo.chunks[chunkData.chunkIndex] = new Uint8Array(chunkData.data);
                fileInfo.receivedSize += chunkData.data.byteLength;
                
                // Update progress
                const progress = (fileInfo.receivedSize / fileInfo.size) * 100;
                document.getElementById(`receive-progress-${chunkData.id}`).style.width = `${progress}%`;
                document.getElementById(`receive-text-${chunkData.id}`).textContent = `${Math.round(progress)}%`;
                
                // If last chunk, assemble file
                if (chunkData.isLast) {
                    this.assembleFile(chunkData.id, fileInfo);
                }
            }
            
            assembleFile(fileId, fileInfo) {
                this.log(`Assembling file: ${fileInfo.name}`);
                
                try {
                    // Calculate total size
                    let totalSize = 0;
                    fileInfo.chunks.forEach(chunk => {
                        if (chunk) totalSize += chunk.length;
                    });
                    
                    // Assemble file
                    const assembled = new Uint8Array(totalSize);
                    let offset = 0;
                    
                    fileInfo.chunks.forEach(chunk => {
                        if (chunk) {
                            assembled.set(chunk, offset);
                            offset += chunk.length;
                        }
                    });
                    
                    // Create blob
                    const blob = new Blob([assembled]);
                    fileInfo.blob = blob;
                    
                    this.log(`File assembled: ${fileInfo.name}, size: ${blob.size}`);
                    
                    // Update UI to show download button
                    const fileDiv = document.getElementById(`receiving-${fileId}`);
                    fileDiv.className = 'download-item';
                    fileDiv.innerHTML = `
                        <div class="file-name">‚úÖ ${fileInfo.name}</div>
                        <div class="file-size">${this.formatFileSize(blob.size)}</div>
                        <button class="btn btn-download" onclick="app.downloadFile(${fileId})">
                            üíæ Download File
                        </button>
                    `;
                    
                    this.showMessage(`‚úÖ ${fileInfo.name} ready to download!`, 'success');
                    
                } catch (error) {
                    this.log(`Assembly error: ${error}`);
                    this.showMessage(`Error receiving ${fileInfo.name}`, 'error');
                }
            }
            
            downloadFile(fileId) {
                const fileInfo = this.receivingFiles.get(fileId);
                if (!fileInfo || !fileInfo.blob) {
                    this.showMessage('File not available', 'error');
                    return;
                }
                
                try {
                    // Check if iOS and has Web Share API
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    
                    if (isIOS && navigator.share) {
                        // Use Web Share API for iOS
                        const file = new File([fileInfo.blob], fileInfo.name);
                        navigator.share({
                            files: [file],
                            title: fileInfo.name
                        }).then(() => {
                            this.showMessage(`Shared: ${fileInfo.name}`, 'success');
                        }).catch(err => {
                            this.log(`Share failed: ${err}`);
                            this.regularDownload(fileInfo.blob, fileInfo.name);
                        });
                    } else {
                        // Regular download for other devices
                        this.regularDownload(fileInfo.blob, fileInfo.name);
                    }
                    
                } catch (error) {
                    this.log(`Download error: ${error}`);
                    this.showMessage('Download failed', 'error');
                }
            }
            
            regularDownload(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                this.showMessage(`Downloaded: ${filename}`, 'success');
                this.log(`Download completed: ${filename}`);
            }
            
            disconnect() {
                if (this.connection) this.connection.close();
                if (this.peer) this.peer.destroy();
                this.resetConnection();
                this.showMessage('Disconnected', 'info');
            }
            
            resetConnection() {
                this.peer = null;
                this.connection = null;
                this.isConnected = false;
                this.connectionCode = '';
                this.receivingFiles.clear();
                
                this.updateStatus('Ready to start', '');
                document.getElementById('code-section').classList.add('hidden');
                document.getElementById('send-btn').disabled = true;
                document.getElementById('connect-btn').classList.remove('hidden');
                document.getElementById('disconnect-btn').classList.add('hidden');
                document.getElementById('sending-files').innerHTML = '';
                document.getElementById('received-files').innerHTML = '';
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            showMessage(message, type) {
                const container = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `status-message status-${type}`;
                messageDiv.textContent = message;
                
                container.innerHTML = '';
                container.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (container.contains(messageDiv)) {
                        container.removeChild(messageDiv);
                    }
                }, 4000);
            }
        }
        
        // Initialize app
        const app = new SimpleFileTransfer();
        
        // Global functions
        function startHost() {
            const deviceText = document.getElementById('device-text');
            if (deviceText.textContent === 'START') {
                app.startHost();
            }
        }
        
        function selectFiles() {
            document.getElementById('file-input').click();
        }
        
        function connectToPeer() {
            app.connectToPeer();
        }
        
        function disconnect() {
            app.disconnect();
        }
    </script>
</body>
</html>
