<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual WebRTC File Transfer</title>
</head>
<body>
    <div id="app">
        <h1>Local Network File Transfer</h1>
        
        <div id="device1" style="border: 1px solid blue; padding: 10px; margin: 10px;">
            <h2>Device 1 (Sender)</h2>
            <button id="createOffer">1. Create Offer</button>
            <textarea id="offerText" placeholder="Offer will appear here" rows="3" cols="50"></textarea>
            <br><br>
            <textarea id="answerInput" placeholder="Paste answer from Device 2" rows="3" cols="50"></textarea>
            <button id="setAnswer">4. Set Answer</button>
            <br><br>
            <input type="file" id="fileInput" multiple>
            <button id="sendFiles">Send Files</button>
            <div id="sendProgress"></div>
        </div>

        <div id="device2" style="border: 1px solid red; padding: 10px; margin: 10px;">
            <h2>Device 2 (Receiver)</h2>
            <textarea id="offerInput" placeholder="Paste offer from Device 1" rows="3" cols="50"></textarea>
            <button id="setOffer">2. Set Offer</button>
            <br><br>
            <textarea id="answerText" placeholder="Answer will appear here" rows="3" cols="50"></textarea>
            <button id="createAnswer">3. Create Answer</button>
            <br><br>
            <div id="receivedFiles">
                <h3>Received Files:</h3>
                <div id="filesList"></div>
            </div>
        </div>
    </div>

    <script>
        let localConnection = null;
        let remoteConnection = null;
        let dataChannel = null;
        let receivingFile = null;
        let receivedChunks = [];

        // Device 1 functions
        document.getElementById('createOffer').addEventListener('click', async () => {
            localConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            dataChannel = localConnection.createDataChannel('files', { ordered: true });
            setupDataChannel();

            const offer = await localConnection.createOffer();
            await localConnection.setLocalDescription(offer);
            
            // Wait for ICE gathering
            localConnection.onicecandidate = (event) => {
                if (event.candidate === null) {
                    document.getElementById('offerText').value = JSON.stringify(localConnection.localDescription);
                }
            };
        });

        document.getElementById('setAnswer').addEventListener('click', async () => {
            const answerText = document.getElementById('answerInput').value;
            if (answerText) {
                const answer = JSON.parse(answerText);
                await localConnection.setRemoteDescription(answer);
                alert('Connection established! You can now send files.');
            }
        });

        // Device 2 functions  
        document.getElementById('setOffer').addEventListener('click', async () => {
            const offerText = document.getElementById('offerInput').value;
            if (offerText) {
                remoteConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                remoteConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };

                const offer = JSON.parse(offerText);
                await remoteConnection.setRemoteDescription(offer);
                document.getElementById('createAnswer').disabled = false;
            }
        });

        document.getElementById('createAnswer').addEventListener('click', async () => {
            const answer = await remoteConnection.createAnswer();
            await remoteConnection.setLocalDescription(answer);
            
            remoteConnection.onicecandidate = (event) => {
                if (event.candidate === null) {
                    document.getElementById('answerText').value = JSON.stringify(remoteConnection.localDescription);
                    alert('Copy the answer above and paste it in Device 1');
                }
            };
        });

        // File sending
        document.getElementById('sendFiles').addEventListener('click', async () => {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0 || !dataChannel || dataChannel.readyState !== 'open') {
                alert('Select files and ensure connection is established');
                return;
            }

            for (const file of files) {
                await sendFile(file);
            }
        });

        async function sendFile(file) {
            const chunkSize = 16384;
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            // Send metadata
            dataChannel.send(JSON.stringify({
                type: 'fileStart',
                name: file.name,
                size: file.size,
                totalChunks: totalChunks
            }));

            document.getElementById('sendProgress').innerHTML = `Sending ${file.name}...`;

            // Send chunks
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                const arrayBuffer = await chunk.arrayBuffer();
                dataChannel.send(arrayBuffer);
                
                const progress = ((i + 1) / totalChunks * 100).toFixed(1);
                document.getElementById('sendProgress').innerHTML = `Sending ${file.name}: ${progress}%`;
                
                // Small delay to prevent overwhelming
                if (i % 50 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
            }

            dataChannel.send(JSON.stringify({ type: 'fileEnd' }));
            document.getElementById('sendProgress').innerHTML = `${file.name} sent successfully!`;
        }

        function setupDataChannel() {
            dataChannel.binaryType = 'arraybuffer';
            
            dataChannel.onopen = () => {
                console.log('Data channel opened');
            };
            
            dataChannel.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'fileStart') {
                        receivingFile = message;
                        receivedChunks = [];
                        console.log('Receiving:', message.name);
                        
                    } else if (message.type === 'fileEnd') {
                        saveReceivedFile();
                    }
                } else {
                    // Binary chunk
                    receivedChunks.push(new Uint8Array(event.data));
                }
            };
        }

        function saveReceivedFile() {
            if (!receivingFile) return;
            
            // Combine chunks
            const totalSize = receivedChunks.reduce((size, chunk) => size + chunk.length, 0);
            const combined = new Uint8Array(totalSize);
            let offset = 0;
            
            for (const chunk of receivedChunks) {
                combined.set(chunk, offset);
                offset += chunk.length;
            }
            
            // Create download
            const blob = new Blob([combined]);
            const url = URL.createObjectURL(blob);
            
            const fileDiv = document.createElement('div');
            fileDiv.innerHTML = `
                <p><strong>${receivingFile.name}</strong> (${formatFileSize(receivingFile.size)})</p>
                <a href="${url}" download="${receivingFile.name}">
                    <button>Download</button>
                </a>
                <hr>
            `;
            document.getElementById('filesList').appendChild(fileDiv);
            
            receivingFile = null;
            receivedChunks = [];
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
